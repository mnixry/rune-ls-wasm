From 816b656a1563b4c4cb6337b22b7dd7c3983bcbc3 Mon Sep 17 00:00:00 2001
From: HexMix <32300164+mnixry@users.noreply.github.com>
Date: Fri, 3 Oct 2025 01:28:53 +0800
Subject: [PATCH] add wasm specific cargo config

---
 .cargo/config.toml                    | 20 ++++++++++++++++++++
 crates/rune-languageserver/Cargo.toml | 24 +++++++++++++++++++++++-
 2 files changed, 43 insertions(+), 1 deletion(-)
 create mode 100644 .cargo/config.toml

diff --git a/.cargo/config.toml b/.cargo/config.toml
new file mode 100644
index 00000000..6ab4877c
--- /dev/null
+++ b/.cargo/config.toml
@@ -0,0 +1,20 @@
+[target.'cfg(target_family = "wasm")']
+rustflags = [
+    "--cfg", "tokio_unstable",
+    "-C", "link-arg=-pthread",
+    "-C", "link-arg=-flto",
+    "-C", "target-feature=+atomics,+bulk-memory,+mutable-globals",
+    "-C", "link-arg=-s", "-C", "link-arg=MODULARIZE=1",
+    "-C", "link-arg=-s", "-C", "link-arg=FORCE_FILESYSTEM=1",
+    "-C", "link-arg=-s", "-C", "link-arg=EXPORTED_RUNTIME_METHODS=FS",
+    "-C", "link-arg=-s", "-C", "link-arg=EXPORT_ES6=1",
+]
+
+[unstable]
+build-std = ["core", "std", "alloc", "proc_macro"]
+
+[profile.release]
+lto = true
+opt-level = "z"
+codegen-units = 1
+panic = "unwind"
diff --git a/crates/rune-languageserver/Cargo.toml b/crates/rune-languageserver/Cargo.toml
index 10338d54..0e324b44 100644
--- a/crates/rune-languageserver/Cargo.toml
+++ b/crates/rune-languageserver/Cargo.toml
@@ -14,14 +14,36 @@ keywords = ["language", "scripting", "scripting-language"]
 categories = ["parser-implementations"]
 
 [dependencies]
-tokio = { version = "1.28.1", features = ["full"] }
+tokio = { version = "*", features = ["sync", "macros", "io-util", "rt", "time"] }
 anyhow = "1.0.71"
 tracing = "0.1.37"
 tracing-appender = "0.2.2"
 tracing-subscriber = { version = "0.3.17", features = ["env-filter"] }
 
 rune = { version = "0.14.0", path = "../rune", features = ["languageserver"] }
+
+[target.'cfg(not(target_family = "wasm"))'.dependencies]
 rune-modules = { version = "0.14.0", path = "../rune-modules", features = ["full"] }
 
+[target.'cfg(target_family = "wasm")'.dependencies]
+rune-modules = { version = "0.14.0", path = "../rune-modules", default-features = false, features = [
+    "time",
+    "json",
+    "toml",
+    "fs",
+    "rand",
+    "os_rng",
+    "small_rng",
+    "std_rng",
+    "thread_rng",
+    "io",
+    "fmt",
+    "base64",
+] }
+
+[dependencies.parking_lot]
+version = "*"
+features = ["nightly"]
+
 [build-dependencies]
 anyhow = "1.0.71"
-- 
2.51.0

